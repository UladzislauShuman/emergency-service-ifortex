<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Password Reset</title>
  <style>
    .error-message { color: red; }
    .success-message { color: green; }
  </style>
</head>
<body>
<div id="reset-container">
  <h2>Reset Your Password</h2>
  <div id="error-message" class="error-message"></div>
  <form id="reset-form">
    <input type="hidden" id="token" name="token" th:value="${token}" />

    <div>
      <label for="newPassword">New Password:</label>
      <input type="password" id="newPassword" name="newPassword" required />
    </div>
    <div>
      <label for="confirmationPassword">Confirm New Password:</label>
      <input type="password" id="confirmationPassword" name="confirmationPassword" required />
    </div>
    <br/>
    <button type="submit">Reset Password</button>
  </form>
</div>

<div id="success-container" class="success-message" style="display: none;">
  <h2>Password Reset Successfully!</h2>
  <p id="success-message"></p>
  <p><a href="/login">Click here to log in</a></p>
</div>

<script>
  document.getElementById('reset-form').addEventListener('submit', async function(event) {
      event.preventDefault();
      const errorDiv = document.getElementById('error-message');
      errorDiv.innerHTML = '';

      const payload = {
          token: document.getElementById('token').value,
          newPassword: document.getElementById('newPassword').value,
          confirmationPassword: document.getElementById('confirmationPassword').value
      };

      try {
          const response = await fetch('/api/auth/password-admin-link', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify(payload)
          });

          const data = await response.json();

          if (!response.ok) {
              if (data.details && data.details.length > 0) {
                   const errorList = data.details.map(detail => `<li>${detail}</li>`).join('');
                   errorDiv.innerHTML = `<ul>${errorList}</ul>`;
              } else {
                  errorDiv.textContent = data.message || 'An error occurred.';
              }
              return;
          }

          document.getElementById('reset-container').style.display = 'none';
          document.getElementById('success-container').style.display = 'block';
          document.getElementById('success-message').textContent = data.message;

      } catch (error) {
          errorDiv.textContent = 'A network error occurred. Please try again.';
      }
  });
</script>
</body>
</html>