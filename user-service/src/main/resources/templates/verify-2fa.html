<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Two-Factor Authentication</title>
  <style>
    .resend-container {
        margin-top: 15px;
        font-size: 0.9em;
    }
    .resend-container a {
        color: #007bff;
        text-decoration: none;
    }
    .resend-container a.disabled {
        color: #6c757d;
        cursor: not-allowed;
        text-decoration: none;
    }
    .cooldown-timer {
        color: #6c757d;
        margin-left: 5px;
    }
  </style>
</head>
<body>

<h2>Two-Factor Authentication</h2>
<p>A verification code has been sent to your email: <strong th:text="${email}"></strong></p>

<form id="verify-2fa-form">
  <div id="error-message" style="color: red;"></div>
  <div id="success-message" style="color: green;"></div>
  <input type="hidden" id="email" th:value="${email}">

  <div>
    <label for="otpCode">Verification Code:</label>
    <input type="text" id="otpCode" name="otpCode" required autofocus>
  </div>

  <button type="submit">Verify</button>
</form>

<div class="resend-container">
  <a href="#" id="resend-link" class="disabled">Resend Code</a>
  <span id="cooldown-timer" class="cooldown-timer"></span>
</div>

<script src="/js/auth.js"></script>
<script>
  const COOLDOWN_SECONDS = 60;
  const resendLink = document.getElementById('resend-link');
  const timerSpan = document.getElementById('cooldown-timer');
  let cooldownInterval;

  function startCooldown() {
      let timeLeft = COOLDOWN_SECONDS;
      resendLink.classList.add('disabled');
      timerSpan.textContent = `(wait ${timeLeft}s)`;

      cooldownInterval = setInterval(() => {
          timeLeft--;
          timerSpan.textContent = `(wait ${timeLeft}s)`;
          if (timeLeft <= 0) {
              clearInterval(cooldownInterval);
              timerSpan.textContent = '';
              resendLink.classList.remove('disabled');
          }
      }, 1000);
  }

  document.addEventListener('DOMContentLoaded', startCooldown);

  resendLink.addEventListener('click', async function(event) {
      event.preventDefault();
      if (resendLink.classList.contains('disabled')) {
          return;
      }

      const email = document.getElementById('email').value;
      const errorMessageDiv = document.getElementById('error-message');
      const successMessageDiv = document.getElementById('success-message');
      errorMessageDiv.textContent = '';
      successMessageDiv.textContent = '';

      try {
          const response = await fetch('/api/auth/otp/resend', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                  email: email,
                  otpType: 'LOGIN_2FA'
              })
          });

          if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.message || 'Failed to resend code.');
          }

          successMessageDiv.textContent = 'A new code has been sent to your email.';
          startCooldown();

      } catch (error) {
          errorMessageDiv.textContent = error.message;
      }
  });

  document.getElementById('verify-2fa-form').addEventListener('submit', async function(event) {
      event.preventDefault();

      const email = document.getElementById('email').value;
      const otpCode = document.getElementById('otpCode').value;
      const errorMessageDiv = document.getElementById('error-message');
      const successMessageDiv = document.getElementById('success-message');
      errorMessageDiv.textContent = '';
      successMessageDiv.textContent = '';

      try {
          const response = await fetch('/api/auth/verification/2fa', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, otpCode })
          });

          const data = await response.json();

          if (!response.ok) {
              throw new Error(data.message || 'Verification failed. Please try again.');
          }

          if (data.accessToken && data.refreshToken) {
              saveToken({ accessToken: data.accessToken, refreshToken: data.refreshToken });
              saveUser(data.user);
              window.location.href = '/home';
          } else {
              throw new Error('An unexpected error occurred.');
          }

      } catch (error) {
          errorMessageDiv.textContent = error.message;
      }
  });
</script>

</body>
</html>