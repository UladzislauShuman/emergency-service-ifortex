<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Paramedic Application</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background-color: #f0f2f5; padding: 20px 0; }
    .container { background-color: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 100%; max-width: 480px; text-align: center; }
    h2 { margin-bottom: 1.5rem; color: #333; }
    .form-group { margin-bottom: 1rem; text-align: left; }
    label { display: block; margin-bottom: 0.5rem; color: #555; font-weight: 500; }
    input { width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    button { width: 100%; padding: 0.75rem; border: none; border-radius: 4px; background-color: #007bff; color: white; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
    button:disabled { background-color: #9acbff; cursor: not-allowed; }
    .message { color: #d93025; margin-bottom: 1rem; min-height: 1.2em; font-size: 0.9rem; text-align: left; }
    .field-error { color: #d93025; font-size: 0.8rem; margin-top: 0.25rem; min-height: 1em; }
    .rejection-reason { background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; text-align: left; }
  </style>
</head>
<body>
<div class="container">
  <h2>Paramedic Application</h2>
  <p>To become a paramedic, please fill out the form and upload the required documents.</p>

  <div id="general-message" class="message"></div>
  <div id="rejection-reason" class="rejection-reason" style="display: none;"></div>

  <form id="kyc-form" enctype="multipart/form-data">
    <div class="form-group">
      <label for="fullName">Full Name:</label>
      <input type="text" id="fullName" name="fullName" required>
      <div id="fullName-error" class="field-error"></div>
    </div>
    <div class="form-group">
      <label for="email">Email Address:</label>
      <input type="email" id="email" name="email" required>
      <div id="email-error" class="field-error"></div>
    </div>
    <div class="form-group">
      <label for="phone">Phone Number:</label>
      <input type="tel" id="phone" name="phone" placeholder="+1234567890" required>
      <div id="phone-error" class="field-error"></div>
    </div>
    <hr style="margin: 20px 0;">
    <div class="form-group">
      <label for="identityDocument">Identity Document (Passport, ID Card)</label>
      <input type="file" id="identityDocument" name="identityDocument" required>
      <div id="identityDocument-error" class="field-error"></div>
    </div>
    <div class="form-group">
      <label for="selfieWithDocument">Selfie with your Document</label>
      <input type="file" id="selfieWithDocument" name="selfieWithDocument" required>
      <div id="selfieWithDocument-error" class="field-error"></div>
    </div>
    <div class="form-group">
      <label for="medicalCertificate">Medical Certificate</label>
      <input type="file" id="medicalCertificate" name="medicalCertificate" required>
      <div id="medicalCertificate-error" class="field-error"></div>
    </div>
    <button type="submit" id="submit-button">Submit Application</button>
  </form>
</div>

<script>
  const form = document.getElementById('kyc-form');
  const generalMessageDiv = document.getElementById('general-message');
  const submitButton = document.getElementById('submit-button');

  function clearErrors() {
      generalMessageDiv.textContent = '';
      document.querySelectorAll('.field-error').forEach(el => el.textContent = '');
  }

  function displayErrors(data) {
      if (data.details) {
          data.details.forEach(detailString => {
              const parts = detailString.split(': ');
              if (parts.length >= 2) {
                  const fieldName = parts[0];
                  const message = parts.slice(1).join(': ');
                  const errorElement = document.getElementById(`${fieldName}-error`);
                  if (errorElement) {
                      errorElement.textContent = message;
                  }
              }
          });
      } else if (data.message) {
          generalMessageDiv.textContent = data.message;
      }
  }

  form.addEventListener('submit', async function (event) {
      event.preventDefault();
      clearErrors();
      submitButton.disabled = true;
      submitButton.textContent = 'Submitting...';

      try {
          const response = await fetch('/api/public/kyc/applications', {
              method: 'POST',
              body: new FormData(form)
          });

          const data = await response.json();

          if (response.ok) {
              const email = new FormData(form).get('email');
              alert(data.message);
              window.location.href = `/paramedic/verify-email?email=${encodeURIComponent(email)}`;
          } else {
              displayErrors(data);
          }
      } catch (error) {
          generalMessageDiv.textContent = 'An unexpected network error occurred. Please try again.';
          console.error(error);
      } finally {
          submitButton.disabled = false;
          submitButton.textContent = 'Submit Application';
      }
  });

  document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const email = urlParams.get('email');
      if (email) {
          document.getElementById('email').value = email;
          try {
              const response = await fetch(`/api/public/kyc/applications?email=${encodeURIComponent(email)}`);
              if (response.ok) {
                  const data = await response.json();
                  if (data.applicationStatus === 'REJECTED' && data.rejectionReason) {
                      const reasonDiv = document.getElementById('rejection-reason');
                      reasonDiv.innerHTML = `<strong>Previous application was rejected:</strong><br>${data.rejectionReason}<br>Please correct the issues and resubmit.`;
                      reasonDiv.style.display = 'block';
                  }
              }
          } catch (e) {
              console.error("Could not fetch KYC status", e);
          }
      }
  });
</script>
</body>
</html>