<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

  <changeSet id="1-create-paramedic-applications-table" author="uladzislau.shuman">
    <createTable tableName="paramedic_applications">
      <column name="id" type="BIGSERIAL">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="email" type="VARCHAR(100)">
        <constraints nullable="false"/>
      </column>
      <column name="full_name" type="VARCHAR(100)">
        <constraints nullable="false"/>
      </column>
      <column name="phone" type="VARCHAR(20)"/>
      <column name="status" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
      <column name="identity_document_path" type="VARCHAR(255)"/>
      <column name="selfie_with_document_path" type="VARCHAR(255)"/>
      <column name="medical_certificate_path" type="VARCHAR(255)"/>
      <column name="rejection_reason" type="TEXT"/>
      <column name="submitted_at" type="TIMESTAMP WITH TIME ZONE"/>
      <column name="reviewed_at" type="TIMESTAMP WITH TIME ZONE"/>
    </createTable>
  </changeSet>

  <changeSet id="2-add-partial-unique-index-for-paramedic-applications" author="uladzislau.shuman">
    <sql dbms="postgresql">
      CREATE UNIQUE INDEX IF NOT EXISTS uc_paramedic_applications_email_on_pending
      ON paramedic_applications (email)
      WHERE status IN ('PENDING_REVIEW', 'PENDING_EMAIL_VERIFICATION');
    </sql>
    <rollback>
      DROP INDEX IF EXISTS uc_paramedic_applications_email_on_pending;
    </rollback>
  </changeSet>

</databaseChangeLog>